<!-- AI Chat Widget - Include this in any page -->
<div id="aiChatWidget" class="ai-chat-widget">

    <!-- Floating Button -->
    <button class="ai-chat-button" onclick="toggleAIChat()">
        <i class="fas fa-robot"></i>
        <span class="chat-tooltip">AI Asistan</span>
    </button>

    <!-- Chat Panel -->
    <div class="ai-chat-panel" id="aiChatPanel">
        <!-- Header -->
        <div class="ai-chat-header">
            <div>
                <i class="fas fa-robot"></i> AI Alƒ±≈üveri≈ü Asistanƒ±
            </div>
            <button class="close-btn" onclick="toggleAIChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Messages -->
        <div class="ai-chat-messages" id="widgetMessages">
            <!-- Welcome Message -->
            <div class="ai-message">
                <strong>ü§ñ AI Asistan</strong>
                <p>Merhaba! Size en uygun √ºr√ºnleri bulmana yardƒ±mcƒ± olabilirim.</p>
                <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                    √ñrnek: "Yazlƒ±k bir ≈üey istiyorum", "200 TL altƒ±nda ne var?"
                </p>
            </div>
        </div>

        <!-- Quick Suggestions -->
        <div class="ai-quick-suggestions">
            <button onclick="sendQuickMessage('Bana √ºr√ºn √∂nerir misin?')">üõçÔ∏è √úr√ºn √ñner</button>
            <button onclick="sendQuickMessage('En uygun fiyatlƒ± √ºr√ºnler')">üí∞ Uygun Fiyat</button>
            <button onclick="sendQuickMessage('Yazlƒ±k √ºr√ºnler')">‚òÄÔ∏è Yazlƒ±k</button>
        </div>

        <!-- Input -->
        <div class="ai-chat-input">
            <input type="text" id="widgetInput" placeholder="Bir ≈üey sorun..."
                onkeypress="if(event.key==='Enter') sendWidgetMessage()">
            <button onclick="sendWidgetMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<style>
    .ai-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        font-family: inherit;
    }

    .ai-chat-button {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1.5rem;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        position: relative;
    }

    .ai-chat-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(102, 126, 234, 0.5);
    }

    .chat-tooltip {
        position: absolute;
        right: 70px;
        top: 50%;
        transform: translateY(-50%);
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .ai-chat-button:hover .chat-tooltip {
        opacity: 1;
    }

    .ai-chat-panel {
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 380px;
        height: 500px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: none;
        flex-direction: column;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    .ai-chat-panel.open {
        display: flex;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
    }

    .ai-chat-header .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .ai-chat-header .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .ai-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #f8f9fa;
    }

    .ai-message {
        background: white;
        padding: 12px 15px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        max-width: 90%;
    }

    .ai-message strong {
        color: #667eea;
        display: block;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }

    .ai-message p {
        margin: 0;
        line-height: 1.5;
        color: #333;
    }

    .ai-message pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: inherit;
        font-size: 0.9rem;
    }

    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 15px;
        border-radius: 12px;
        max-width: 90%;
        align-self: flex-end;
    }

    .ai-quick-suggestions {
        padding: 10px 15px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        background: white;
        border-top: 1px solid #eee;
    }

    .ai-quick-suggestions button {
        padding: 6px 12px;
        background: #f0f0f0;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }

    .ai-quick-suggestions button:hover {
        background: #667eea;
        color: white;
    }

    .ai-chat-input {
        padding: 15px;
        display: flex;
        gap: 10px;
        background: white;
        border-top: 1px solid #eee;
    }

    .ai-chat-input input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #eee;
        border-radius: 25px;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .ai-chat-input input:focus {
        border-color: #667eea;
    }

    .ai-chat-input button {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .ai-chat-input button:hover {
        transform: scale(1.05);
    }

    .loading-indicator {
        display: flex;
        gap: 5px;
        padding: 15px;
    }

    .loading-indicator span {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .loading-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* Mobile Responsive */
    .ai-product-link {
        display: inline-block;
        background-color: #6366f1;
        color: white !important;
        padding: 2px 8px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9em;
        margin: 0 4px;
        font-weight: bold;
    }

    .ai-product-link:hover {
        background-color: #4f46e5;
    }

    .ai-store-link {
        background-color: #10b981;
    }

    .ai-store-link:hover {
        background-color: #059669;
    }

    .ai-category-link {
        background-color: #f59e0b;
    }

    .ai-category-link:hover {
        background-color: #d97706;
    }

    @media (max-width: 480px) {
        .ai-chat-panel {
            width: calc(100vw - 40px);
            height: 70vh;
            right: -10px;
        }
    }
</style>

<script>
    // Fonksiyonlar - Global scope (hoisting ile her zaman eri≈üilebilir)
    function toggleAIChat() {
        var panel = document.getElementById('aiChatPanel');
        if (panel) {
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                setTimeout(function () {
                    var input = document.getElementById('widgetInput');
                    if (input) input.focus();
                }, 100);
            }
        }
    }

    function sendQuickMessage(text) {
        var input = document.getElementById('widgetInput');
        if (input) {
            input.value = text;
            sendWidgetMessage();
        }
    }

    function sendWidgetMessage() {
        var input = document.getElementById('widgetInput');
        var messages = document.getElementById('widgetMessages');
        if (!input || !messages) return;

        var text = input.value.trim();
        if (!text) return;

        var userMsg = document.createElement('div');
        userMsg.className = 'user-message';
        userMsg.textContent = text;
        messages.appendChild(userMsg);

        input.value = '';
        input.disabled = true;

        var loadingMsg = document.createElement('div');
        loadingMsg.className = 'ai-message';
        loadingMsg.id = 'loadingMsg';
        loadingMsg.innerHTML = '<div class="loading-indicator"><span></span><span></span><span></span></div>';
        messages.appendChild(loadingMsg);
        messages.scrollTop = messages.scrollHeight;

        fetch('/api/ai/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: text })
        })
            .then(function (response) { return response.json(); })
            .then(function (data) {
                var loading = document.getElementById('loadingMsg');
                if (loading) loading.remove();

                var aiMsg = document.createElement('div');
                aiMsg.className = 'ai-message';
                aiMsg.innerHTML = '<strong>ü§ñ AI Asistan</strong><div class="ai-response-text">' + formatAIResponse(data.response || data.cevap) + '</div>';
                messages.appendChild(aiMsg);
                messages.scrollTop = messages.scrollHeight;
            })
            .catch(function (error) {
                var loading = document.getElementById('loadingMsg');
                if (loading) loading.remove();

                var errorMsg = document.createElement('div');
                errorMsg.className = 'ai-message';
                errorMsg.innerHTML = '<strong>ü§ñ AI Asistan</strong><p>Baƒülantƒ± hatasƒ±.</p>';
                messages.appendChild(errorMsg);
            })
            .finally(function () {
                input.disabled = false;
                input.focus();
            });
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatAIResponse(text) {
        if (!text) return 'Cevap alƒ±namadƒ±';
        var safeText = escapeHtml(text);
        safeText = safeText.replace(/\n/g, '<br>');

        // Maƒüaza Linkleri
        safeText = safeText.replace(/\[\[MAGAZA:(\d+)\]\]/g, function (m, id) {
            return '<a href="/magazalar?magazaId=' + id + '" class="ai-product-link ai-store-link" target="_blank">üè™ Maƒüazaya Git</a>';
        });

        // Kategori Linkleri
        safeText = safeText.replace(/\[\[KATEGORI:(\d+)\]\]/g, function (m, id) {
            return '<a href="/magazalar?kategoriId=' + id + '" class="ai-product-link ai-category-link" target="_blank">üìÇ Kategoriye Git</a>';
        });

        // √úr√ºn Linkleri
        safeText = safeText.replace(/\[\[URUN:(\d+)\]\]/g, function (m, id) {
            return '<a href="/urun/' + id + '" class="ai-product-link" target="_blank">üîó √úr√ºne Git</a>';
        });

        return safeText;
    }
</script>